{% extends "base.html" %}

{% block title %}Watch List{% endblock %}

{% block content %}
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">

<style>
    .positive { color: red; }
    .negative { color: green; }
</style>

<div class="w3-container" style="display: flex; align-items: center;">
    <h2 style="margin-right: 20px;">Watch List</h2>
    
    <!-- Form for adding new stock symbol -->
    <form action="/add_stock" method="post" style="flex-grow: 1; display: flex; align-items: center;">
        <input type="text" name="stock_symbol" placeholder="Enter stock symbol" required 
               style="height: 36px; border-radius: 10px; flex-grow: 1; margin-right: 10px;">
        <button type="submit" class="w3-btn w3-blue">Add</button>
    </form>
</div>

<table class="w3-table-all w3-hoverable" id="sortableTable">
    <thead>
      <tr class="w3-light-grey">
        <th style="width: 50px;">Sort</th>
        <th style="width: 50px;">Remove</th>
        <th>Stock Symbol</th>
        <th>Company Name</th>
        <th>Price</th>
        <th>Change</th>
        <th>% Change</th>
      </tr>
    </thead>
    <tbody>
      {% for symbol, description in symbols.items() %}
      <tr draggable="true" id="stock-{{ symbol }}">
        <td>
          <i class="fa fa-bars" aria-hidden="true" style="cursor: grab;"></i> <!-- Sort icon -->
        </td>
        <td>
          <form action="/remove_stock" method="post" style="display: inline;">
            <input type="hidden" name="stock_symbol" value="{{ symbol }}">
            <button type="submit" class="w3-button" style="padding: 8px; border: none; background: none;">
              <i class="fa fa-trash"></i>
            </button>
          </form>
        </td>
        <td>{{ symbol }}</td>
        <td>{{ description if description else "Futures" }}</td>
        <td id="stock-{{ symbol }}-price">-</td>
        <td id="stock-{{ symbol }}-change">-</td>
        <td id="stock-{{ symbol }}-change_pct">-</td>
      </tr>
      {% endfor %}
    </tbody>
</table>

<script src="https://cdn.socket.io/4.0.0/socket.io.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', (event) => {
    let draggedElement = null;

    document.querySelectorAll('#sortableTable tbody tr').forEach(row => {
        row.addEventListener('dragstart', function (e) {
            draggedElement = this;
        });

        row.addEventListener('dragover', function (e) {
            e.preventDefault();  // Necessary to allow dropping
        });

        row.addEventListener('drop', function (e) {
            if (this !== draggedElement) {
                let allRows = Array.from(this.parentNode.children);
                let draggedIndex = allRows.indexOf(draggedElement);
                let droppedIndex = allRows.indexOf(this);

                if (draggedIndex < droppedIndex) {
                    this.parentNode.insertBefore(draggedElement, this.nextSibling);
                } else {
                    this.parentNode.insertBefore(draggedElement, this);
                }

                // Optionally send the updated order to the server
                updateOrderOnServer();
            }
        });
    });
});

function updateOrderOnServer() {
    let symbols = Array.from(document.querySelectorAll('#sortableTable tbody tr')).reduce((map, row) => {
        let symbol = row.cells[2].textContent.trim();
        let value = row.cells[3].textContent.trim(); // assuming the value is in the 4th column
        map.set(symbol, value);
        console.log(`Added symbol: ${symbol}, value: ${value}`); // Debug log
        return map;
    }, new Map());
    console.log('Symbols map:', Array.from(symbols)); // Debug log
    fetch('/update_watchlist_order', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({order: Object.fromEntries(symbols)})
    })
    .then(response => {
        console.log('Server response:', response); // Debug log
        return response.json();
    })
    .then(data => {
        console.log('Order updated:', data);
    })
    .catch((error) => {
        console.error('Error:', error);
    });
	
	console.log('Final order object:', Object.fromEntries(symbols));
}

document.addEventListener('DOMContentLoaded', function() {
    var socket = io();

    socket.on('connect', function() {
        console.log('Connected to server');
    });

    socket.on('stock_data', function(data) {
        console.log('Stock data received:', data);
        for (var symbol in data) {
            updateStockData(symbol, data[symbol]);
        }
    });

    function updateStockData(symbol, tick) {
        let row = document.getElementById(`stock-${symbol}`);
        if (row) {
            let priceElem = row.querySelector(`#stock-${symbol}-price`);
            let changeElem = row.querySelector(`#stock-${symbol}-change`);
            let changePctElem = row.querySelector(`#stock-${symbol}-change_pct`);

            priceElem.innerText = tick.close;
            changeElem.innerText = tick.change;
            changePctElem.innerText = tick.change_pct;

            if (tick.change >= 0 && tick.change_pct >= 0) {
                priceElem.className = 'negative';
                changeElem.className = 'negative';
                changePctElem.className = 'negative';
            } else {
                priceElem.className = 'positive';
                changeElem.className = 'positive';
                changePctElem.className = 'positive';
            }
        } else {
            console.log('Element not found for symbol:', symbol);
        }
    }
});

function updateStockData(symbol, tick) {
    let row = document.getElementById(`stock-${symbol}`);
    if (row) {
        let priceElem = row.querySelector(`#stock-${symbol}-price`);
        let changeElem = row.querySelector(`#stock-${symbol}-change`);
        let changePctElem = row.querySelector(`#stock-${symbol}-change_pct`);

        priceElem.innerText = tick.close;
        changeElem.innerText = tick.change;
        changePctElem.innerText = tick.change_pct;

        // Determine color based on change values
        if (tick.change >= 0 && tick.change_pct >= 0) {
            changeElem.classList.add('positive');
            changePctElem.classList.add('positive');
            priceElem.classList.add('positive');

            changeElem.classList.remove('negative');
            changePctElem.classList.remove('negative');
            priceElem.classList.remove('negative');
        } else {
            changeElem.classList.add('negative');
            changePctElem.classList.add('negative');
            priceElem.classList.add('negative');

            changeElem.classList.remove('positive');
            changePctElem.classList.remove('positive');
            priceElem.classList.remove('positive');
        }
    } else {
        console.log('Element not found for symbol:', symbol);
    }
}

</script>

{% endblock %}
